---
title: "R Notebook"
output: html_notebook
---
# Preprocessing of eyetracking eyelink data 
- exclusion of : 
  - blinks and 100ms before and after these data samples 
  - data samples outside of the screen range 
  - coordinates smaller than 1 degree 			
  - exclude catch trials 
- screen coordinates [pixels] were converted to spherical angles [degree]


```{r}
  library("eyelinker")
  library("intervals")
  library("dplyr")
  library("R.matlab")
n_sub = 4 
  # load behavioural data 
# prepare data frame for collecting responses to empty categories 

category_to_be_deleted_all_subjects <- data.frame(matrix(ncol = 7, nrow = 0))
x <- c("sub", "block", "trial", "cond",  "exemplar", "response", "category")
colnames(category_to_be_deleted_all_subjects) <- x
percentage_deleted = double(30)
for (sub in 2:n_sub){
  sub
  #file_beh <- paste("/Users/ghaeberle/Downloads/FixCrossExp_s1cfgdata.mat")
  
  file_beh <- paste("/Users/ghaeberle/scratch/data/FixEyeEEG/main/behav_data/FixCrossExp_s",
                    sub,"cfgdata.mat",sep="")
  dat_cfg <- readMat(file_beh)
  exp_data <- dat_cfg$data #data collected during the experiment
  #ntrials <- 3000
  ntrials = 4200
  # create data frame for behavioral data 
  behav_data <- data.frame(sub=rep(sub,ntrials),
                       block=NA,
                       trial=rep(1:ntrials),
                       cond=NA,
                       exemplar=NA,
                       response=NA,
                       category=NA)
  
  behav_data$block <- t(dat_cfg$block)
  behav_data$cond <- as.factor(dat_cfg$cond) #standard(2) or bullseye(1)
  resp <- dat_cfg$data[8] #keyboard press
  behav_data$response <- t(resp[[1]])
  behav_data$exemplar <- exp_data[[7]] 
  behav_data$category <- t(exp_data[[9]])

  # load eyetracking data and preprocess 
  file_eye =  paste("/Volumes/ESD-USB/FixEyeEEGMAIN/eye",sub,".asc",sep="")
  #file_eye <- paste("/Users/ghaeberle/scratch/data/FixEyeEEG/main/eyetracking/raw/",sub,"/eye",sub,".asc",sep="")
  dat = read.asc(file_eye)
  raw = dat$raw # raw eyemovement data 
  
  # Delete Catch Trials 
  catch = behav_data$trial[behav_data$category == 999]
  raw_without_catch =raw[!raw$block %in% catch,]

  #exclusion of pauses 
  msg = dat$msg
  head(msg)
  pauses_start = msg$time[which(msg$text=="PAUSE")]
  pauses_end = msg$time[which(msg$text=="PAUSE")+2]
  pauses = cbind(pauses_start, pauses_end)

  # between excludes everything >= value, but the end of our pause is already the beginning of the next trial!! 
  raw_without_pauses = raw_without_catch %>% dplyr::filter(!(dplyr::between(time, pauses[,1],pauses[,2]-1)))

  # exclusion of blinks + 100ms before and after 
  blinks = cbind(dat$blinks$stime, dat$blinks$etime) # Define a set of intervals
  blinks_df = filter(raw_without_pauses, time %In% blinks)
  length(unique(blinks_df[["block"]]))

  hundretMS_blinks = Intervals(blinks) %>% expand(100, "absolute")

  #exclusion of out of range values 
  out_of_range_cx = na.omit(raw_without_pauses[raw_without_pauses$xp>1680,])
  out_of_range_cy = na.omit(raw_without_pauses[raw_without_pauses$yp>1050,])
  tmp_cx = cbind(out_of_range_cx$time,out_of_range_cx$time)
  tmp_cy = cbind(out_of_range_cy$time,out_of_range_cy$time)
  hundreths_cx = Intervals(tmp_cx) %>% expand(100, "absolute")
  hundreths_cy = Intervals(tmp_cy) %>% expand(100, "absolute")
  
  # exclusion of negative values 
  negative_cx = na.omit(raw_without_pauses[raw_without_pauses$xp<0,])
  negative_cy = na.omit(raw_without_pauses[raw_without_pauses$yp<0,])
  tmp_ncx = cbind(negative_cx$time, negative_cx$time)
  tmp_ncy = cbind(negative_cy$time, negative_cy$time)
  hundreths_ncx = Intervals(tmp_ncx) %>% expand(100, "absolute")
  hundreths_ncy = Intervals(tmp_ncy) %>% expand(100, "absolute")
  
  
  # actual exclusion of all values 
 # raw_without_pauses = raw_without_catch %>% filter(!(between(time, pauses[,1],pauses[,2])))
  df_eyetracking_cleaned = raw_without_pauses %>% 
    filter(!(dplyr::between(time,hundretMS_blinks[,1], hundretMS_blinks[,2]))) %>% 
    filter(!(dplyr::between(time,hundreths_cx[,1], hundreths_cx[,2]))) %>% 
    filter(!(dplyr::between(time,hundreths_cy[,1], hundreths_cy[,2]))) %>% 
    filter(!(dplyr::between(time,hundreths_ncx[,1], hundreths_ncx[,2]))) %>% 
    filter(!(dplyr::between(time,hundreths_ncy[,1], hundreths_ncy[,2]))) 
  # check how many trials we would in principle lose 

 #check for remaining NAs
  nan_values = is.na(df_eyetracking_cleaned)
  array_ind_nan_values = which(nan_values, arr.ind = TRUE)
  unique_nan_rows = unique(array_ind_nan_values[,1])
  trials = df_eyetracking_cleaned[unique_nan_rows,]
  unique_trials = unique(trials$block)
  df_eyetracking_cleaned_nas = na.omit(df_eyetracking_cleaned)

  unique_blocks_with = unique(df_eyetracking_cleaned_nas$block)
  missing_trials  = subset(df_eyetracking_cleaned, !(block %in% df_eyetracking_cleaned_nas$block))
  
  
  # how many trials are remaining after deleting these trials 
  remaining = length(unique(df_eyetracking_cleaned$block)) - 
    length(unique(blinks_df$block))- 
    length(unique(out_of_range_cx$block)) -
    length(unique(out_of_range_cy$block)) - 
    length(unique(negative_cx$block)) - 
    length(unique(negative_cy$block)) 
  
  throw_away =  length(unique(blinks_df$block))+ 
    length(unique(out_of_range_cx$block)) +
    length(unique(out_of_range_cy$block)) + 
    length(unique(negative_cx$block)) +
    length(unique(negative_cy$block))
  
  # percentage left over trials 
  100/length(unique(df_eyetracking_cleaned$block))*remaining
  
  
  # find out which trials need to be deleted: 
  trial_numbers_to_be_deleted = unique(c(unique(blinks_df$block),
                               unique(out_of_range_cx$block),
                               unique(out_of_range_cy$block),
                               unique(negative_cx$block),
                               unique(negative_cy$block),
                               unique_trials))
  
  # find out which category and exemplar these belong to: 
  category_to_be_deleted = behav_data[behav_data$trial %in% trial_numbers_to_be_deleted,]
  category_to_be_deleted$exemplar = category_to_be_deleted$exemplar %>% unlist()
  category_to_be_deleted_all_subjects = rbind(category_to_be_deleted_all_subjects,category_to_be_deleted)
  percentage_deleted[sub] = 100/length(unique(df_eyetracking_cleaned$block))*length(category_to_be_deleted$exemplar)
  
  
  # remove trials from continous eyetracking data 
  df_eyetracking_cleaned_witout_trials_with_missing_timepoints = df_eyetracking_cleaned[!df_eyetracking_cleaned$block %in%  trial_numbers_to_be_deleted,]
  
  
  # save data
  
  #behavioural data
  save(behav_data, file =paste("behav_data_",sub,".Rda",sep=""))
 # fwrite(behav_data, file =paste("behav_data_",sub,".csv",sep=""))
  
  # # cleaned eyetracking data with all trials included 
  # save(df_eyetracking_cleaned, 
  #      file=paste("/Users/ghaeberle/scratch/data/FixEyeEEG/main/eyetracking/preprocessed/allTrials/eyetracking_cleaned_sub00",sub,".Rda",sep=""))

  #convert pixels to spherical degrees
  conversion_px_degree_monitor = 0.26458333
  x_size_monitor = 1680
  y_size_monitor = 1050
  distance_to_monitor = 600
  df_eyetracking_cleaned_witout_trials_with_missing_timepoints$xp_centered <- df_eyetracking_cleaned_witout_trials_with_missing_timepoints$xp - x_size_monitor/2
  df_eyetracking_cleaned_witout_trials_with_missing_timepoints$yp_centered <- df_eyetracking_cleaned_witout_trials_with_missing_timepoints$yp - y_size_monitor/2
  mmy <- df_eyetracking_cleaned_witout_trials_with_missing_timepoints$yp_centered / conversion_px_degree_monitor
  mmx <- df_eyetracking_cleaned_witout_trials_with_missing_timepoints$xp_centered / conversion_px_degree_monitor
  df_eyetracking_cleaned_witout_trials_with_missing_timepoints$y_visual_angle <- 2*atan2(df_eyetracking_cleaned_witout_trials_with_missing_timepoints$yp_centered*mmy,distance_to_monitor)
  df_eyetracking_cleaned_witout_trials_with_missing_timepoints$x_visual_angle <- 2*atan2(df_eyetracking_cleaned_witout_trials_with_missing_timepoints$xp_centered*mmx,distance_to_monitor)
  
  
  save(df_eyetracking_cleaned_witout_trials_with_missing_timepoints, 
       file=paste("/Users/ghaeberle/scratch/data/FixEyeEEG/main/eyetracking/preprocessed/cleaned/eyetracking_cleaned_wo_artifacts_and_visual_degree_sub00",sub,".Rda",sep=""))
  
  
 write.csv(df_eyetracking_cleaned_witout_trials_with_missing_timepoints, 
      file=paste("/Users/ghaeberle/scratch/data/FixEyeEEG/main/eyetracking/preprocessed/cleaned/eyetracking_cleaned_wo_artifacts_and_visual_degree_sub00",sub,".csv",sep=""))
   
  
     
  # categories that have been deleted for all subjects
  #writeMat('/Users/ghaeberle/Downloads/eyetracking_data.mat', eyetracking_cleaned = df_eyetracking_cleaned)
  write.csv(category_to_be_deleted,
            file=paste("/Users/ghaeberle/scratch/data/FixEyeEEG/main/eyetracking/preprocessed/cleaned/deleted_categories_sub00",sub,".csv",sep=""))

  # trial numbers that need to be deleted
  write.csv(trial_numbers_to_be_deleted, 
             file=paste("/Users/ghaeberle/scratch/data/FixEyeEEG/main/eyetracking/preprocessed/cleaned/deleted_trial_numbers_sub00",sub,".csv",sep=""))

 
  remove(category_to_be_deleted)
  remove(df_eyetracking_cleaned)
  remove(df_eyetracking_cleaned_witout_trials_with_missing_timepoints)
  remove(trial_numbers_to_be_deleted)
  }


save(category_to_be_deleted_all_subjects, 
       file=paste("/Users/ghaeberle/scratch/data/FixEyeEEG/main/eyetracking/preprocessed/cleaned/deleted_categories_all_subs.Rda",sep=""))
# trial numbers that need to be deleted 
  
write.csv(percentage_deleted, 
            file=paste("/Users/ghaeberle/scratch/data/FixEyeEEG/main/eyetracking/preprocessed/cleaned/percentage_deleted.csv",sep=""))
  
  
```


### evaluate missing trials for presentation with Radek 

```{r}
library(plyr)
library(ggplot2)
library(reshape2)
# combine all deleted category files into one data file 
category_to_be_deleted_all_subjects <- data.frame(matrix(ncol = 8, nrow = 0))
x <- c("trial, sub", "block", "trial", "cond",  "exemplar", "response", "category")
colnames(category_to_be_deleted_all_subjects) <- x

for (sub in 1:n_sub){
  file_category_deleted = paste("/Users/ghaeberle/scratch/data/FixEyeEEG/main/eyetracking/preprocessed/trials_wo_artefacts/deleted_categories_sub00",sub,".csv",sep="")
  df = read.csv2(file_category_deleted, sep = ',')
  category_to_be_deleted_all_subjects = rbind(category_to_be_deleted_all_subjects,df)
}


head(category_to_be_deleted_all_subjects)
plyr::count(category_to_be_deleted_all_subjects, "sub")
category_to_be_deleted = category_to_be_deleted_all_subjects[category_to_be_deleted_all_subjects$sub == 1,]

plyr::count(category_to_be_deleted, "exemplar")
plyr::count(category_to_be_deleted, "category")
plyr::count(category_to_be_deleted, "cond")

category_to_be_deleted_all_subjects$cond = recode(category_to_be_deleted_all_subjects$cond,
                                                  '1' = "bullseye", '2' = "standard")

category_to_be_deleted_all_subjects$category = recode(category_to_be_deleted_all_subjects$category, 
                                                      '0' = "inanimate", '1' = "animate")

with(category_to_be_deleted_all_subjects, table(sub, category))
with(category_to_be_deleted_all_subjects, table(sub, cond))
with(category_to_be_deleted_all_subjects, table(sub, category, cond))
options(max.print=1000000)
table_sub_exemplar_cond = with(category_to_be_deleted_all_subjects, table(sub, exemplar, cond))
#plot(matrix_sub_exemplar_cond)
with(category_to_be_deleted_all_subjects, table( exemplar, cond))


sub_exemplar_cond_long = melt(table_sub_exemplar_cond)

ggplot(sub_exemplar_cond_long, aes(x = exemplar, y = sub)) + 
  geom_raster(aes(fill=value)) + 
  scale_fill_gradient(low="grey90", high="red") +
  facet_grid(. ~ cond) +
  theme_bw() + theme(axis.text.x=element_text(size=9, angle=0, vjust=0.3),
                     axis.text.y=element_text(size=9),
                     plot.title=element_text(size=11))

ggplot(sub_exemplar_cond_long, aes(x = sub, y = exemplar)) + 
  geom_raster(aes(fill=value)) + 
  scale_fill_gradient(low="grey90", high="red") +
  facet_grid(. ~ cond) +
  theme_bw() + theme(axis.text.x=element_text(size=9, angle=0, vjust=0.3),
                     axis.text.y=element_text(size=9),
                     plot.title=element_text(size=11))


```
## convert data
```{r}

  #convert pixels to spherical degrees
  conversion_px_degree_monitor = 0.26458333
  x_size_monitor = 1680
  y_size_monitor = 1050
  distance_to_monitor = 600
  df_eyetracking_cleaned_witout_trials_with_missing_timepoints$xp_centered <- df_eyetracking_cleaned_witout_trials_with_missing_timepoints$xp - x_size_monitor/2
  df_eyetracking_cleaned_witout_trials_with_missing_timepoints$yp_centered <- df_eyetracking_cleaned_witout_trials_with_missing_timepoints$yp - y_size_monitor/2
  mmy <- df_eyetracking_cleaned_witout_trials_with_missing_timepoints$yp_centered / conversion_px_degree_monitor
  mmx <- df_eyetracking_cleaned_witout_trials_with_missing_timepoints$xp_centered / conversion_px_degree_monitor
  df_eyetracking_cleaned_witout_trials_with_missing_timepoints$y_visual_angle <- 2*atan2(df_eyetracking_cleaned_witout_trials_with_missing_timepoints$yp_centered*mmy,distance_to_monitor)
  df_eyetracking_cleaned_witout_trials_with_missing_timepoints$x_visual_angle <- 2*atan2(df_eyetracking_cleaned_witout_trials_with_missing_timepoints$xp_centered*mmx,distance_to_monitor)

  write.csv(df_eyetracking_cleaned_witout_trials_with_missing_timepoints, 
       file=paste("/Users/ghaeberle/scratch/data/FixEyeEEG/main/eyetracking/preprocessed/trials_wo_artefacts/eyetracking_cleaned_wo_artifacts_sub00",sub,".csv",sep=""))


```
## calculate sacccades and microsaccade rate for all participants 


```{r}
library(dplyr)
library(data.table)
source('/Users/ghaeberle/Documents/PhD/project/FixEyeEEG/scripts/MS_Toolbox_R/microsacc.R')
source('/Users/ghaeberle/Documents/PhD/project/FixEyeEEG/scripts/MS_Toolbox_R/vecvel.R')
# gather all subjects in one big data frame if the script was run for subjects individually 

cleaned_trials_all_subjects <- data.frame(matrix(ncol = 10, nrow = 0))
x <- c("block", "time", "xp", "yp", "ps",  "cr.info", "xp_centered", "yp_centered", "y_visual_angle", "x_visual_angle")
colnames(cleaned_trials_all_subjects) <- x
n_sub = 30

# create data frame for all subjects 
df_all_subj_all_sacs_behav = data.frame(matrix(ncol=18,nrow =0))
colnames(df_all_subj_all_sacs_behav) = c("subj" ,"block" ,'trial', 'onset', 'end', 'peak_velocity', 
                 'horizontal_comp', 'vertical_comp',
			            'horizontal_amp', 'vertical_amp', 
			            "duration", "amplitude", "cond", "exemplar", "response" ,"category","checkResp", "acc"	)

# calculate accuracy for all subjects 
for (sub in 1:n_sub){
 cleaned_trials = paste("/Users/ghaeberle/scratch/data/FixEyeEEG/main/eyetracking/preprocessed/trials_wo_artefacts/eyetracking_cleaned_wo_artifacts_and_visual_degree_sub00",sub,".Rda",sep="")
  load(cleaned_trials)
  behav_files = paste("/Users/ghaeberle/scratch/data/FixEyeEEG/main/behav_data/behav_data_",sub,".Rda",sep="")
  load(behav_files)
  behav_data$checkResp[behav_data$category==999 & behav_data$response==1] ='Hit'
  behav_data$checkResp[behav_data$category!=999 & behav_data$response==1] ='FA'
  behav_data$checkResp[behav_data$category!=999 & behav_data$response==0] ='CR'
  behav_data$checkResp[behav_data$category==999 & behav_data$response==0] ='Miss'
  
  behav_data$acc <- round(length(behav_data$checkResp[behav_data$checkResp=='Hit']) / 
                        (length(behav_data$checkResp[behav_data$checkResp=='Miss'])+
                           length(behav_data$checkResp[behav_data$checkResp=='Hit'])),2)
  save(behav_data,
      file = paste("/Users/ghaeberle/scratch/data/FixEyeEEG/main/eyetracking/preprocessed/trials_wo_artefacts/eyetracking_cleaned_wo_artifacts_sub00",sub,".Rda",sep="" ))
  
  # set parameters for algorithm 
SAMPLING = 1000
MINDUR = 8 #duration criterion
VFAC = 8 #velocity criterion


  microsaccades <- matrix(data=NA, ncol=8)
  colnames(microsaccades) <- c("onset", "end", "vpeak", 
                    "comph", "compv","amph", "ampv","trial")

  list_microsaccades_all_trials = df_eyetracking_cleaned_witout_trials_with_missing_timepoints[,9:10] %>%
    split(df_eyetracking_cleaned_witout_trials_with_missing_timepoints$block) %>% 
    lapply(as.matrix) %>% 
    lapply(microsacc, VFAC=VFAC, MINDUR = MINDUR, SAMPLING = SAMPLING)
  
  
  # extract table for all trials from list inside list and get amount of detected saccades per trial 
  df_all_sacs = list_microsaccades_all_trials %>% 
    lapply(`[[`, 'table') %>%
    lapply(as.data.frame) %>%
    bind_rows(.id = "column_label")
  
  col_names = c('trial', 'onset', 'end', 'peak_velocity', 
                 'horizontal_comp', 'vertical_comp',
			            'horizontal_amp', 'vertical_amp'	)
  colnames(df_all_sacs) = col_names
  
  # get number of saccades per trial 

  df_all_sacs$subj = sub
  df_all_sacs$duration = df_all_sacs$end-df_all_sacs$onset
  df_all_sacs$amplitude = sqrt(df_all_sacs$horizontal_amp^2+df_all_sacs$vertical_amp^2)
  n_saccades_per_trial = as.data.frame(table(df_all_sacs$trial))
  
  
  # replicate behaviour data according to the amount of saccades present in the dataset 
  behav_df_saccades = bind_rows(replicate(n_saccades_per_trial[1,2],dplyr::filter(behav_data, trial == n_saccades_per_trial[1,1]), simplify = FALSE))
  for (idx in 2:nrow(n_saccades_per_trial)){
  tmp  = bind_rows(replicate(n_saccades_per_trial[idx,2],filter(behav_data, trial == n_saccades_per_trial[idx,1]), simplify = FALSE))
  behav_df_saccades = rbind(behav_df_saccades,tmp) 
  }
  
  # order data set by trials 
  behav_df_saccades = behav_df_saccades %>% arrange(trial)
  
  df_all_sacs_behav = cbind(df_all_sacs, behav_df_saccades[-1])                
  # remove doubled trial column 
  df_all_sacs_behav$trial = NULL      
  
  #reorder columns 
  col_order <- c("subj" ,"block" ,'trial', 'onset', 'end', 'peak_velocity', 
                 'horizontal_comp', 'vertical_comp',
			            'horizontal_amp', 'vertical_amp', 
			            "duration", "amplitude", "cond", "exemplar", "response" ,"category","checkResp", "acc"	)
 df_all_sacs_behav = df_all_sacs_behav[, col_order]
 df_all_subj_all_sacs_behav = rbind(df_all_subj_all_sacs_behav,df_all_sacs_behav)
  
 remove(df_all_sacs_behav)
 remove(df_all_sacs)
 remove(behav_data)
 remove(behav_df_saccades)
save(df_all_subj_all_sacs_behav, 
      file="/Users/ghaeberle/scratch/data/FixEyeEEG/main/eyetracking/preprocessed/trials_wo_artefacts/df_all_subj_all_sacs_behav_tmp.Rda")

}

save(df_all_subj_all_sacs_behav, 
      file="/Users/ghaeberle/scratch/data/FixEyeEEG/main/eyetracking/preprocessed/trials_wo_artefacts/df_all_subj_all_sacs_behav.Rda")


  

```

